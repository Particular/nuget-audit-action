name: NuGet audit

on:
  workflow_call:
    secrets:
      PROCESSNUGETAUDITRESULTS_KEY:
        required: true

jobs:
  nuget-audit:
    runs-on: ubuntu-22.04    
    steps:
      - name: Checkout
        uses: actions/checkout@v4.2.2
      - name: Setup .NET SDK
        uses: actions/setup-dotnet@v4.1.0
        with:
          global-json-file: global.json
      - name: .NET Restore
        id: restore
        run: dotnet restore src
      - name: Report results on failure
        if: ${{ failure() }}
        shell: bash
        working-directory: ./src
        run: |
          mkdir ${{ github.workspace }}/results
          dotnet list package --vulnerable --include-transitive --format json >> "${{ github.workspace }}/results/vulnerabilities.json"
          jq -s '.' */obj/project.assets.json > "${{ github.workspace }}/results/all.project.assets.json"
          BRANCH=$(git rev-parse --abbrev-ref HEAD)
          COMMIT=$(git rev-parse HEAD)
          curl -X POST -F "repository=${{ github.repository_id }}" -F 'branch=$BRANCH' -F 'commit=$COMMIT' -F "vulnerabilities=${{ github.workspace }}/results/vulnerabilities.json" -F "assets=${{ github.workspace }}/results/all.project.assets.json" -H "x-functions-key: ${{ secrets.PROCESSNUGETAUDITRESULTS_KEY }}" https://internalautomation.azurewebsites.net/api/ProcessNuGetAuditResults
      - name: Archive files on failure
        if: ${{ failure() }}
        uses: actions/upload-artifact@v4
        with:
          name: files
          path: ${{ github.workspace }}/results/*.json
